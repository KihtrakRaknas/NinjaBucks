<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Ninja Bucks</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.1.0/firebase-database.js"></script>

    <script>
      // Your web app's Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyB9qbG1G1TBucaoEZvvsevtQ172HHGDyXQ",
        authDomain: "cnninjabucks.firebaseapp.com",
        databaseURL: "https://cnninjabucks.firebaseio.com",
        projectId: "cnninjabucks",
        storageBucket: "cnninjabucks.appspot.com",
        messagingSenderId: "426732205898",
        appId: "1:426732205898:web:fd70fd4678e0ee59c7f3b3",
        measurementId: "G-6GV7BPG258"
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      firebase.analytics();

      var database = firebase.database();
    </script>
  </head>
  <body style="background-color: black">
    <input
      id="search"
      style="margin-top:3px;margin-bottom:10px;"
      type="text"
      class="form-control"
      placeholder="Search"
      aria-label="Search"
    />
    <div>
      <table class="table table-dark">
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Ninja Bucks</th>
          </tr>
        </thead>
        <tbody id="ninjas"></tbody>
      </table>
    </div>

    <div class="modal" tabindex="-1" role="dialog" id="myModal">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="nbName">Modal title</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div
            class="modal-body"
            style="display: flex;  align-items: center; justify-content: center;"
          >
            <button
              type="button"
              class="btn btn-outline-success"
              style="margin-bottom: 2px"
              class="text-center"
              onClick="add()"
            >
              +</button
            ><input
              type="text"
              class="form-control"
              id="nbInput"
              style="margin-bottom: 2px"
            /><button
              type="button"
              class="btn btn-outline-danger"
              onClick="sub()"
            >
              -
            </button>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              onClick="updateWName()"
            >
              Save changes
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
      integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
      integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
      integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
      crossorigin="anonymous"
    ></script>

    <script>
      function req(){
        return prompt("Enter Password");
      }
      function getUrlVars() {
        var vars = {};
        var parts = window.location.href.replace(
          /[?&]+([^=&]+)=([^&]*)/gi,
          function(m, key, value) {
            vars[key] = value;
          }
        );
        return vars;
      }

      var CNcenter = 'cn-nj-kendall-park'
      if(getUrlVars()["center"])
        CNcenter = getUrlVars()["center"]
      
      var shouldClose = false;
      if (getUrlVars()["name"] && getUrlVars()["number"])
        firebase
          .database()
          .ref(CNcenter)
          .once("value", function(snapshot) {
            var name = decodeURIComponent(getUrlVars()["name"]);
            if (name) {
              var newVal = 0;
              if (Number(snapshot.val()[name]))
                newVal = Number(snapshot.val()[name]);
              if (Number(getUrlVars()["number"]))
                newVal += Number(getUrlVars()["number"]);
              shouldClose = true;
              console.log(name);
              console.log(newVal);
              updateWval(newVal, name);
            } else alert("Name not found: " + name);
          });
      else console.log("No Params");
      document.getElementById("search").addEventListener("input", function() {
        if (document.getElementById("search").value == "") {
          updateTable(globalUsers);
        }else if(document.getElementById("search").value == "reset"){
          window.localStorage.clear();
          alert("RESET")
        }else {
          var newList = {};
          for (nin in globalUsers) {
            if (
              nin
                .toLocaleLowerCase()
                .includes(
                  document.getElementById("search").value.toLocaleLowerCase()
                )
            )
              newList[nin] = globalUsers[nin];
          }
          updateTable(newList);
        }
      });






      function updateWName() {
        var name = document.getElementById("nbName").innerText;
        var newVal = document.getElementById("nbInput").value;
        updateWval(newVal, name);
      }

      function add() {
        var name = document.getElementById("nbName").innerText;
        var newVal = document.getElementById("nbInput").value;
        if (newVal != "" && Number(newVal) != null) {
          newVal = Number(newVal);
          newVal += 10;
        }
        updateWval(newVal, name);
      }

      function sub() {
        var name = document.getElementById("nbName").innerText;
        var newVal = document.getElementById("nbInput").value;
        console.log("sub");
        if (newVal != "" && Number(newVal) != null) {
          console.log("sub");
          newVal = Number(newVal);
          newVal -= 10;
          console.log(newVal);
        }
        updateWval(newVal, name);
      }

      function updateWval(newVal, name) {
        var auth = window.localStorage.getItem("auth");
        if (auth == "true") {
          console.log(newVal);
          if (newVal !== "" && Number(newVal) != null) {
            newVal = Number(newVal);
            console.log(newVal);
            firebase
              .database()
              .ref(CNcenter)
              .update({
                [name]: newVal
              })
              .then(() => {
                if (shouldClose) window.close();
              });
          }
        } else {
          var authKey = prompt("Enter Password"); // IK this is super insecure but in this instance security theatre is all thats necessary
          if (authKey == "h@nds@nitizer") {
            window.localStorage.setItem("auth", "true");
            updateWval(newVal, name);
          }
        }
        $("#myModal").modal("hide");
      }

      function showModal(name, old) {
        document.getElementById("nbInput").value = old;
        document.getElementById("nbName").innerText = name;
        $("#myModal").modal("show");
      }

      var globalUsers = {};
      function updateTable(obj) {
        var table = document.getElementById("ninjas");
        table.innerHTML = "";
        for (nin in obj) {
          table.innerHTML +=
            `
                 <tr onclick="showModal('` +
            nin +
            `', ` +
            obj[nin] +
            `)">
                      <th scope="row">` +
            nin +
            `</th>
                      <td>` +
            obj[nin] +
            `</td>
                    </tr>
                `;
        }
      }

      firebase
        .database()
        .ref(CNcenter)
        .on("value", function(snapshot) {
          globalUsers = snapshot.val();
          updateTable(snapshot.val());
        });

    </script>
  </body>
</html>
